---
subtitle: "Project Analysis"
author: "Mean Girls 2 + Raymond Chen, Maria Henriquez, Martha Aboagye, Calleigh Smith"
date: "`r Sys.Date()`"
output: pdf_document
fig_width: 6 
fig_height: 4 
---

# Hotel Booking Demand: STA 210 Project Analysis

### Environment Setup

```{r load-packages, message = FALSE, echo=FALSE}
library(tidyverse)
library(broom)
library(knitr) 
library(patchwork)
library(GGally)
library(MASS)
library(pROC)
library(plotROC)
library(dplyr)
library(modelr)
library(caret)
library(leaps)
```

```{r echo=FALSE}
knitr::opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE)
```

```{r load-data, message = FALSE, echo=FALSE}
# load the data
hotels <- read_csv("data/hotel_bookings.csv")
```

## Introductionn

When talking about our group interests, it became clear that each of us has a passion for travel and other cultures. A lot of our co-curricular activities at Duke have been travel related, whether that be through DukeEngage, study abroad, athletics, or other club activities. We identified early on that we wanted to choose a data set that involved the travel industry and were interested in gaining insights that would lead us to be more informed explorers. As a result, we decided to investigate a hotel dataset, which has information about hotel booking demand. More specifically, this dataset contains information regarding two hotels in Portugal. More information on the data can be found below.

Our research question is:
>Can we predict whether a customer is going to cancel their hotel booking? 

To answer this question, we will build a logistic regression model and see which variables are significant in predicting cancellations. The response variable for our logistic regression model is `is_canceled`, which is a binary categorical variable that has values of either 0 or 1. 1 corresponds to a cancelled booking and 0 corresponds to non-cancelled bookings. The explantory variables we will use for our logistic regression model are the following:

* `adr`, the average daily rate of a booking
  + We predict that a booking is less likely to be cancelled if it has a higher daily rate.
* `adults`, the number of adults per booking
  + We expect that if there are a lot of adults on a booking, then the probability of a cancellation is more likely because there could be more conflicts.
* `arrival_date_month`, the month of an arrival (we will use this to make a new variable, `season`)
  + We expect that season will affect whether a booking is cancelled.
* `babies` + `children`, the number of babies and children per booking, respectively (we will use these to make a new variable `infants`, which indicates if a booking included babies or children)
  + We expect that a booking with more infants on the reservation will increase chances of cancellation, as infants are unpredictable and could get sick suddenly.
* `booking_changes`, the number of changes made to the booking before check-in (we will use this to make a new variable, `changed` which indicates whether a  booking had 1 or more `booking_changes` or not)
  + We expect the probability of cancellation to be higher for more booking changes, as the customer might be indecisive or have concerns about traveling.
* `country`, the country that a customer is from (we will make a variable `origin` that classifies a customer as being a domestic or international traveler)
  + We expect that whether a customer is from Portugal or has to travel internationally will affect cancellation.
* `hotel`, whether the hotel is the city or resort hotel
  + We expect that the city hotel will have more cancellations, as people travel to the city for business or events, which are likely to change more frequently.
* `is_repeated_guest`, whether a guest is a repeated guest or not
  + We expect that repeated guests will be more loyal to the hotel and not cancel their bookings.
* `lead_time`, the amount of days between when a booking was made and when the guest checked-in
  + We expect that there will be more cancellations for bookings with high lead times, as unexpected circumstances might arise that would lead to a booking needing to be cancelled.
* `market_segment`, the market segment designation of a guest
  + We expect that the market segment of a guest might impact cancellation.
* `previous_cancellations`, the number of previous cancellations a guest has made
  + We expect guests with previous cancellations to be serial cancellers or more likely to cancel than guests who have never cancelled (we will use this to create a new variable, `prior_cancellation` that indicates whether the client has ever cancelled a booking at the hotel prior to the current booking)
* `stays_in_weekend_nights` + `stays_in_week_nights`, the number of weekend nights and week nights, respectively, in a booking (we will use these to make a new variable, `length_stay`)
 + We expect that longer stays will be less likely to be cancelled, as these bookings probably have more planning that go into them.

### Dataset Description

`hotels` contains hotel booking data. There are 119,390 observations, each representing a single hotel booking. The bookings were retrieved from one city hotel in Lisbon, Portugal, and one resort hotel in Algarve, Portugal.  Both datasets include bookings due to arrive between July 1, 2015, and August 31, 2017, including bookings that effectively arrived and bookings that were canceled.

The data set includes 32 variables of interest, including information about each booking, such as whether the booking was cancelled (`is_cancelled`), the customer’s meal plan (`meal`), room type (`assigned_room_type`), when the booking was made (`arrival_date_year`, `arrival_date_month`, `arrival_date_day`),  the length of the stay (`stay_weekend_nights`, `stay_week_days`), the number of adults, children, and/or babies (`adults`, `children`, `babies`), and the number of required parking spaces (`required_car_parking_spaces`), among others.  A detailed description of all 32 variables can be found in the code book.

The data was originally from the article “Hotel Booking Demand Datasets,” written by Nuno Antonio, Ana Almeida, and Luis Nunes for the journal *Data in Brief*, Volume 22, which was published in February 2019.  The data set we will be using was cleaned by Thomas Mock and Antoine Bichat during the week of February 11th, 2020 for #TidyTuesday.

In the article “Hotel Booking Demand Datasets,” the authors state that the data was extracted from the hotels’ public Property Management System (PMS) databases’ servers "by executing a TSQL query on SQL Server Studio Manager, the integrated environment tool for managing Microsoft SQL databases."  The article assured that there was no missing data in the data sets constructed.  Since this is real hotel data,  all identifying data elements about the hotel or the customer were deleted.

While the primary table used to compile the data set was “Bookings,” the researchers joined the “Bookings” table with other tables, including “Bookings change log,” “Meals,” “Distribution Channels,” “Transactions,” “Customer Profiles,” “Nationalities,” and “Market Segments,” to get a more complete picture of the variables that affect bookings.

The documentation for the original data set can be found here: $\\$
https://www.sciencedirect.com/science/article/pii/S2352340918315191

### Data Wrangling

We need to do some data wrangling before we can proceed with working with the data.

```{r wrangle-data}
hotels <- hotels %>%
  mutate(
    is_canceled = as.factor(is_canceled),
    adr = as.numeric(adr),
    hotel = as.factor(hotel),
    numinfants = (children + babies),
    numinfants = as.integer(numinfants),
    numinfants = case_when(
      is.na(numinfants) ~ 0,
      TRUE ~ as.numeric(numinfants)
    ),
    infants = case_when(
      numinfants > 0 ~ "yes",
      numinfants == 0 ~ "no"
    ),
    infants = as.factor(infants),
    length_stay = (stays_in_weekend_nights + stays_in_week_nights),
    length_stay = as.integer(length_stay),
    origin = case_when(
      country == "PRT" ~ "domestic",
      TRUE ~ "international"),
    is_repeated_guest = as.factor(is_repeated_guest),
    season = case_when(
      arrival_date_month == "January" | arrival_date_month == "February" | 
        arrival_date_month == "December" ~ "Winter",
      arrival_date_month == "March" | arrival_date_month == "April" | 
        arrival_date_month == "May" ~ "Spring",
      arrival_date_month == "June" | arrival_date_month == "July" | 
        arrival_date_month == "August" ~ "Summer",
      arrival_date_month == "September" | arrival_date_month == "October" | 
        arrival_date_month == "November" ~ "Fall"),
    season = fct_relevel(season, "Spring", "Summer", "Fall", "Winter"),
    lead_time_squared = `^`(lead_time,2),
    changed = case_when(
      booking_changes > 0 ~ "yes",
      booking_changes == 0 ~ "no"
    ),
    changed = as.factor(changed),
    prior_cancellation = case_when(
      previous_cancellations > 0 ~ "yes",
      previous_cancellations == 0 ~ "no"
    ),
    prior_cancellation = as.factor(prior_cancellation)
  ) %>%
  filter(market_segment != "Undefined")
```

Now that we've mutated our dataset to our necessities, we will now get a smaller subset of the dataset that does not include the variables that we are not considering for the model.

```{r smaller-data}
hotels_small <- subset(hotels,
  select = -c(country, agent, company, arrival_date_year, arrival_date_month,
              arrival_date_week_number, arrival_date_day_of_month, children,
              meal, distribution_channel, previous_bookings_not_canceled,
              reserved_room_type, assigned_room_type, days_in_waiting_list, 
              customer_type, required_car_parking_spaces, total_of_special_requests,
              reservation_status, stays_in_weekend_nights, stays_in_week_nights, numinfants,
              previous_cancellations, booking_changes))
```

### Exploratory Data Analysis

Before we continue with finding a model, we will complete an exploratory data analysis to understand the variables we are dealing with.

#### Univariate Analysis

#### `is_canceled`

```{r canceled, fig.width=6, fig.height=3}
# plot number of booking changes
p1 <- ggplot(hotels_small, mapping = aes(x = is_canceled)) +
  geom_bar() +
  labs(x = "Canceled?", y = "Count", title = "Cancellations")

# summarize number of booking changes
p1 + gridExtra::tableGrob(hotels_small %>%
  count(is_canceled) %>%
  mutate(n = n, prop = n/sum(n)))
```

`is_canceled` is the response variable for our logisitic regression model. From the distribution and the table above, we see that approxiamtely 36.15% of the booking observations in our data sample were canceled. 

#### `adr`

```{r adr, warning=FALSE, fig.height=3 }
# plot average daily rate
p1 <- ggplot(hotels_small, mapping = aes(x = adr)) +
  geom_histogram(binwidth = 50) +
  labs(x = "Average Daily Rate", y = "Count", title = "Average Daily Rate")

# summarize average daily rate
p1 / gridExtra::tableGrob(hotels_small %>%
  summarize(min = min(adr), q1 = quantile(adr, 0.25), median = median(adr), 
            q3 = quantile(adr, 0.75), max = max(adr), IQR = IQR(adr),
            loweroutlier = (q1 - 1.5*IQR), upperoutlier = (q3 + 1.5*IQR)))
```

From the graph of `adr`, the average daily rate, we can see that the distribution is skewed right. The center (median) is at 94.59 euros. The spread is about 56.71 euros, which is not that large. However, it appears that there are outliers towards the higher end of the spectrum (above 211.07 euros). The maximum for the distribution is 5,400 euros, which is well above the normal range of average daily rates. For our analysis, we will only consider average daily rates that are not outliers (< 211.07 euros), as we are interested in predicting cancellation for the average client.

#### `lead_time`

```{r lead-time, fig.height=2.8}
# plot lead time
p1 <- ggplot(hotels_small, mapping = aes(x = lead_time)) +
  geom_histogram(binwidth = 10) +
  labs(x = "Days between Booking and Check-In", y = "Count", 
       title = "Lead Time before Check-In")

# summarize lead time
p1 / gridExtra::tableGrob(hotels_small %>%
  summarize(min = min(lead_time), q1 = quantile(lead_time, 0.25), 
            median = median(lead_time), q3 = quantile(lead_time, 0.75), 
            max = max(lead_time), IQR = IQR(lead_time),
            loweroutlier = (q1 - 1.5*IQR), upperoutlier = (q3 + 1.5*IQR)))
```

From graph of `lead_time`, the number of days between booking the hotel and checking in, we can see that the distribution is skewed right. The center (median) is at 69 days, meaning that people normally book their hotels a little over 2 months in advance. The spread is 142 days, which means that there is a decent amount of variability in terms of how far in advance a client reserves a space at the hotel. However, it appears that there are outliers towards the higher end of the spectrum (above 373 days (approximately a year)). Furthermore, it's a bit surprising to see that a great number of bookings were made on the same day as the check-in. This is probably not unusual for a city hotel, but for a resort, it might be. The maximum for the distribution is 737 days (approximately 2 years). We would only like to consider bookings with a lead-time of a year, or 365 days.

#### `prior_cancellation`

```{r prior-cancellation, fig.width=8, fig.height=3}
# plot prior cancellation
p1 <- ggplot(hotels_small, mapping = aes(x = prior_cancellation)) +
  geom_bar() +
  labs(x = "Prior Cancellation", y = "Count", 
       title = "Prior Cancellation before Booking")

# summarize previous cancellations
p1 + gridExtra::tableGrob(hotels_small %>%
  count(prior_cancellation) %>%
  mutate(n = n, prop = n/sum(n)))
```

From graph of `prior_cancellation`, an indicator of whether the client who reserved a booking had previously cancelled a booking before the current booking, we can see that the vast majority of bookings (94.57%) were reserved lients who had never cancelled a booking at the hotel before.

#### `hotel`

```{r hotel, fig.width=6, fig.height=3}
# plot which hotel
p1 <- ggplot(hotels_small, mapping = aes(x = hotel)) +
  geom_bar() +
  labs(x = "Type of Hotel", y = "Count", title = "City vs. Resort Hotel")

# count which hotel
p1 + gridExtra::tableGrob(hotels_small %>%
  count(hotel) %>%
  mutate(n = n, prop = n/sum(n)))
```

From the bar chart of `hotel`, the type of hotel the booking was made for, we can see that the vast majority of bookings in the data set (66.45%) were made for the city hotel, while the remaining bookings (33.55%) were made for the resort hotel.


#### `market_segment`

```{r market_segment, fig.width=8, fig.height=3}
# plot market segment
p1 <- ggplot(hotels_small, mapping = aes(x = market_segment)) +
  geom_bar() +
  labs(x = "Market Segment Designation", y = "Count", 
       title = "Market Segment Guest Designations")

# count market segment
p1 + gridExtra::tableGrob(hotels_small %>%
  count(market_segment) %>%
  mutate(n = n, prop = n/sum(n)))
```

From the bar chart of `market_segment`, which is the market segment designation for a given booking, we can see that the vast majority of bookings in the data set (47.30%) have a market segment designation of Online TA (Travel Agent), followed by Offline TA/TO, then Groups, then Direct, then Corporate, then Complementary, and finally Aviation (0.20%).


#### Bivariate Analysis

#### `lead_time` vs. `is_cancelled`

```{r lead-time-is-cancelled, warning = FALSE, fig.height=3}
p1 <- ggplot(hotels_small, aes(x= is_canceled, y = lead_time)) +
  geom_boxplot(fill = "darkorange") + 
  labs(x = "Is Canceled", y = "Lead Time (Days)", 
       title = "Cancellation vs. Lead Time", subtitle = "Boxplots") +
  ylim(-1,365)

#p2 <- ggplot(hotels_small, aes(lead_time)) +
#  geom_histogram() +
#  facet_wrap(vars(is_canceled), scales = "free_y")

p3 <- ggplot(hotels_small, aes(x=lead_time, fill = is_canceled)) +
  geom_density(alpha = .5) +
  labs(fill = "Is Canceled", x = "Lead Time (Days)", y = "Density",
       title = "Cancellation vs. Lead Time", subtitle = "Density Plot") +
  xlim(-1,365)

#p1 + (p2 / p3)
p1+p3
```

The boxplot of `lead_time` vs. `is_canceled` shows that bookings that were canceled had a larger median `lead_time`. Canceled bookings also had a larger IQR. The histogram and density plot of `lead_time` by `is_canceled` is right skewed for both canceled and non-canceled bookings. The distribution for `lead_time` for non-canceled bookings is more right skewed skewed and has a smaller spread than the `lead_time` for non-canceled submissions. Most of the `lead_time` for non-canceled bookings is between 0 and 200 days while for canceled submissions, the `lead_time` is usually between 0 and 400 days.


#### `market_segment` vs. `is_canceled`

```{r market-segment-vs-is-cancelled, fig.height=3}
ggplot(hotels_small, aes(x=market_segment, fill=is_canceled)) + 
  geom_bar(position="fill") +
  labs(x = "Market Segment Designation", y = "Proportion",
       title = "Cancellation vs. Market Segment", fill = "Is Canceled")
```

The bar graph of `is_canceled` vs. `market_segment` shows that the market segment that has the highest proportion of canceled reservations are Groups. Next, Online TA and Offline TA/TO have the third highest proportion of canceled reservations, although for those market segments, reservations are still more likely to not be canceled than canceled. Direct, Corporate, Complementary and Aviation market segments have proportions of about a 25% cancelation rate.

#### `adr`, `prior_cancellation`, and `changed` vs. `is_canceled`

```{r prev-cancellations, warning = FALSE}
# adr
p1 <- ggplot(hotels_small, mapping = aes(x = adr)) +
  geom_histogram(binwidth = 50, fill = "aquamarine4") +
  facet_wrap(vars(is_canceled)) +
  labs(x = "Average Daily Rate (Euros)", y = "Count", title = "Average Daily Rate (Euros)") +
  xlim(0,212)

# prior cancellation
p2 <- ggplot(hotels_small, mapping = aes(x = prior_cancellation, fill = is_canceled)) +
  geom_bar(position = "fill")  +
  labs(x = "Prior Cancellation", y = "Proportion", title = "Prior Cancellation")

#booking changes.
p3 <- ggplot(hotels_small, mapping = aes(x = changed, fill = is_canceled)) +
  geom_bar(position = "fill")  +
  labs(x = "Booking Changed", y = "Proportion", title = "Booking Changed")

p1 + p2 / p3
```
The histogram of average daily rate by `is_canceled` shows that the distribution of average daily rate is roughly the same across canceled and non-canceled reservations. For both canceled and non-canceled reservations, the average daily rate is typically between 0 and 250 euros with the most frequent average daily rate being about 100 euros.

The bar chart of `prior_cancellation` by `is_canceled` shows that bookings reserved by clients who have previously cancelled a reservation at the hotel are significantly more likely to be canceled compared to bookings reserved by clients who have never canceled a reservation before.

The bar chart of `changed` by `is_canceled` shows that a booking is more likely to be canceled if a booking has never been changed compared to if a booking was modified.

#### Clean Data Further

We now will filter the observations to exclude unnecessary outliers in the following variables: `adr`, `adults`, and `lead_time`. We chose to fit our model only on these filtered observations because we want our model to best apply to the most "likely" case. We encourage future work to consider building a model for only extreme cases in variables.

We will also center three variables for interpretation purposes: `adults`, `adr`, and `length_stay`.

```{r unusual}
# filter outliers
hotels_small <- hotels_small %>%
  filter(adr < 211.06,
         adults <= 10 & adults >= 1,
         market_segment != "Undefined",
         lead_time <= 365,
         )

# mean center relevant variables
hotels_small <- hotels_small %>%
  mutate(
    adultsCent = adults - median(adults),
    adrCent = adr - mean(adr),
    length_stayCent = length_stay - mean(length_stay)
  )
```

Our data set is also extremely large (over 110,000 observations). Therefore, we will take a random sample of 10,000 observations from the original data set to make our analysis more efficient and generalizable. 

```{r random-sample}
set.seed(10081999)
hotels_subset <- sample_n(hotels_small, 10000) %>%
  mutate(obs_num = 1:n())

#glimpse(hotels_subset)
```


## Regression Analysis

Due to the fact that we have a categorical response variable with two levels (`is_canceled`), we will fit a binary logistic regression model. 
We began by fitting a full model with 12 variables and 4 interaction variables. The squared the variable `lead_time` to satisify the Linearity condition.

More specifically we considered the following 4 interaction effects. 
$\\$ `lead_time` x `changed` $\\$ 
`season` x `adr` $\\$
` hotel` x `adr` $\\$
`season` x `lead_time` $\\$

We chose to explore these four interactions because we beleived from previous knowledge that out of all the variables we were exploring, these variables seemed the most likely to relate to one another. 

We then performed a backwards selection with BIC as the criterion. We chose BIC as the selection criterion because we have a lot of variables and want to strictly penalize for any variables that are not truly necessary. Since our model is intended to be used by hotel personnel, we wanted to keep it as simple and efficient as possible.

The backwards selection using BIC removed `adultsCent`, `infants`, and all of the interaction variables. 

It did not remove the variable `lead_time_squared`, but the estimated coefficient was extremely small, and so because we did not believe it was practically significant, we decided to remove the variable from the model. 

Below is the final model after BIC selection and removing `lead_time_squared`.

```{r final-model}
select_model <- glm(is_canceled ~ 
                    adrCent +  
                    season + 
                    changed +
                    origin +
                    hotel + 
                    is_repeated_guest + 
                    market_segment +  
                    prior_cancellation +
                    length_stayCent, 
                  data = hotels_subset, 
                  family = binomial)

tidy(select_model, conf.int=TRUE, exponentiate=FALSE) %>%
  kable(format="markdown", digits=3)

```


### Model Assumptions

Now we will check the model assumptions for logistic regression, which include linearity, randomness, and independence.

```{r augment}
# calculating predictions and residuals
canceled_m_aug <- augment(select_model, type.predict = "response", type.residuals = "response")
canceled_m_aug <- canceled_m_aug %>%
  mutate(obs_num = 1:n())

```

#### Linearity

In order to make a conclusion about linearity, we must look at the binned residuals vs. the predicted probabilities, the binned residuals vs. the quantitative predictor variables, and the mean residuals for the categorical variables. We will start with the binned residual plots.


```{r binned-plots, fig.height=3}
#predicted probabilities
pred_probs_binned <- arm::binnedplot(x = canceled_m_aug$.fitted, y = canceled_m_aug$.resid,
                xlab = "Predicted Probabilities", 
                main = "Binned Residual vs. Predicted Values", 
                col.int = FALSE)

#adr
adr_binned <- arm::binnedplot(x = canceled_m_aug$adrCent, 
                y = canceled_m_aug$.resid, 
                col.int = FALSE,
                xlab = "Average Daily Rate", 
                main = "Binned Residual vs. Average Daily Rate")

#length_stay
length_stay_binned <- arm::binnedplot(x = canceled_m_aug$length_stayCent, 
                y = canceled_m_aug$.resid, 
                col.int = FALSE,
                xlab = "Length of Stay (Days)", 
                main = "Binned Residual vs. Length of Stay")



```

Based on the binned residual plots, it seems evident that the linearity condition is satisfied in all of the plots. None of the plots show signs of any obvious pattern or shape, and the points are all scattered randomly about the horizontal line where `average residual = 0`.

Now let's look at the average residuals for the categorical variables.

```{r linearity-categorical}

t1<-canceled_m_aug %>%
  group_by(season) %>%
  summarise(mean_resid = mean(.resid))
 
t2<-canceled_m_aug %>%
  group_by(origin) %>%
  summarise(mean_resid = mean(.resid))

t3<-canceled_m_aug %>%
  group_by(hotel) %>%
  summarise(mean_resid = mean(.resid))

t4<-canceled_m_aug %>%
  group_by(market_segment) %>%
  summarise(mean_resid = mean(.resid))

t5<-canceled_m_aug %>%
  group_by(prior_cancellation) %>%
  summarise(mean_resid = mean(.resid))

t6<-canceled_m_aug %>%
  group_by(changed) %>%
  summarise(mean_resid = mean(.resid))

kable(list(t2, t3))
kable(list(t5, t6))
kable(list(t4, t1))
```


We can see that for our categorical variables all of the mean residuals are extremely close to 0, which is what we want for linearity to be satisfied.

Since the binned residual plots and the tables of the average residuals generally show no departures from linearity, we believe it is safe to assume that the linearity condition is satisfied.


#### Randomness

In order to assess randomness, we must look at how the original data was collected. We know that all of the bookings come from only 2 hotels in Portugal, 1 resort hotel and 1 city hotel. This certainly is a specific subset of hotels. Due to this, our model is not as generalizable as we would like it to be and can really only be generalized to hotels in Portugal. However, the bookings that are included in the dataset are ALL bookings at the two hotels between July 1st, 2015 and August 31st, 2017. Since our model does not isolate or exclude bookings pertaining to any given group, the randomness condition is satisfied for our dataset.

#### Indepenence

We believe that the hotel bookings in our data set are independent.  Since there are a large number of bookings and since the bookings are from all different kinds of guests, we have no reason to believe that the bookings are related to each other or that one booking affects another booking.  Another thing we have to consider is that since our data set has a time dependency (all bookings have a date associated with them), we have to look at the scatterplot of the residuals vs. date.

```{r check-independence}
joined <- inner_join(hotels_subset, canceled_m_aug, by = "obs_num")

ggplot(data = joined, aes(x = reservation_status_date, y = .resid)) + 
  geom_point(alpha = 0.1) +
  labs(x = "Date of Booking", y = "Residuals", 
       title = "Residuals vs. Date of Booking")
```

Based on the scatterplot, it does not look like the serial effect is a factor in our data set. The scatterplot does not have any obvious pattern like a sinusoidal shape or trend that would indicate that cancellations are dependent on time. It is clear from the plot, however, that the volume of bookings increases over time and that our model tends to overpredict the probabilities of cancellations for bookings since the residuals (observed - predicted) are concentrated below `residuals = 0`.

### Model Fit Statistics

Below is the ROC curve and the calculated AUC for the final model.

```{r model-analysis, fig.height=4}
# ROC from select_model
roc_curve <- ggplot(canceled_m_aug, 
                    aes(d = as.numeric(is_canceled) - 1,
                        m = .fitted)) + 
  geom_roc(n.cuts = 10, labelround = 3) + 
  geom_abline(intercept = 0) + 
  labs(x = "False Positive Rate (1 - Specificity)",
       y = "True Positive Rate (Sensitivity)")

roc_curve

# calculate auc
(auc <- calc_auc(roc_curve)$AUC)
```

Based on the ROC curve and AUC, which is `r auc`, our model does a relatively good job of determining whether a hotel booking at the two hotels will be cancelled or not. Our model is able to differentiate cancellations about `r auc*100`% of the time.


## Discussion 

The coefficient for our intercept is -1.496.  
We expect the odds of a domestic City hotel booking made the day of (lead_time = 0) in the Spring with an average daily rate of 97.80 dollars made for 3.42 days and for 2 adults by someone who is not a repeated guest, has made no booking changes, and has made no previous cancellations to be `r exp(-1.496)`.

For our final model,  predictors that increased the probability of a reservation being cancelled are all levels of `market_segment` other than the baseline, `prior_cancellationyes`, `changed`,  `length_stayCent`,  and `adrCent`. The predictors that decreased the probability of a reservation being cancelled were all `season` levels aside from the baseline, `is_repeated_guest1`, `hotelResort Hotel`, `origininternational` and `changedyes`. The predictors that weren't statistically signifcant predictors of whether a reservation would be cancelled was `infants` and `adults`. Although BIC selection did not remove `lead_timeSquared`  remove from our model, it had a coefficient of 0 which it means it is not a  practically signifcant predictor of whether a reservation will be cancelled.

We intially hypothesized that as the quantity of  `adults`, `infants`, `adr`,  and `lead_time` increase, the probability of a reservation being canceled would also increase.The results of our model only supports our initial hypothesis for `adr`.  Our model predicts that for every additional increase in `adr` above the mean, we expect  the odds of a reservation being cancelled to multiply by a factor of  `r exp(0.009)`

Our initial hypothesis for `infants`,`adults`, `lead_time`  was not supported by the results of our model. Through BIC, we found  that `infants` and `adults` weren't significant predictor of whether a reservation will be cancelled. Although BIC didn't remove `lead_time` from our model, its coefficient is zero which means it is not a  practically significant predictor of whether a reservation will be cancelled or not.


For the categorical variables, we hypothesized that the levels `hotelCity Hotel`, `prior_cancellationyes`, `origininternational` and `changedyes` and `is_repeated_guest_no`  would increase the probability of a reservation being cancelled. For `hotel`, we hypothesized as more people travel to the city for business or events, their plans are more likely to change. For `prior_cancellation` we thought that if a customer has cancelled a reservation before, they would be more likely to cancel a reservation in general. For `origin`, we thought that international reservations would have a higher probabibility of being cancelled. Finally, for `change`, we thought that a reservation being changed multiple times served as a good indication of a customer's plan being uncertain. We hypothesized that if details of a reservation had been changed, the reservation would have a higher probability of being cancelled. 


Our model provided evidence to support our initial hypothesis for  `hotelCity Hotel`, `is_repeated_guest_yes` and `prior_cancellationyes`. With city Hotel as the baseline level, the coefficient for `hotelresort Hotel` has a coefficient of -0.580. This means that holding all else constant, the odds of cancellation for a resort hotel is exp(-0.580) times lower the odds of cancellation for a city hotel. `is_repeated_guest_yes` has a coeffiecient of -3.795. This means that holding all else constant, we expect the odds for a reservation being canceled is exp(-3.795) times lower for repeat guest than a non repeat guest.  `prior_cancellationyes` had a  coefficient 4.242. This means that holding all else constant, the odds of cancellation for  guests with previous cancellations is exp(4.242) times the odds of cancellation for guests with no previous cancellations. 

Our model did not provide any evidence to support our initial hypothesis that `changedyes` and `originternational` would increase the probability for a reservation being cancelled. Both `changedyes` and `originternational` have negative coefficients which means that they decrease the odds of a reservation being cancelled. `changedyes` has a coefficient of -1.049 and `originternational` has a coefficient of -1.967. This means that for a reservation that has been changed, the odds of a reservation being cancelled is exp(-1.049) times lower than the odds of cancellation for a reservation that hasn't been changed. Likewise for a reservation that is international. the odds of the reservation being cancelled is exp(-1.967) times lower than the odds of a domestic reservation.


The AUC for our model was 0.8121267. This means that about `r auc*100`% of the time, our model is able to identify whether a booking will be canceled or not. Our model does a relatively good job of determining whether a hotel booking will be cancelled or not.
Based  ROC curve, we believe that the best threshold value for predicting whether a reservation will be cancelled or not is about `0.30`. In choosing our threshold, the most important factor we considered was the practical financial implications of having large scale unanticipated cancelations. We assume that for hotels, being able to roughly estimate the amount customers who might cancel will allow them to better fill vacancies and maximimize profits. In addition, being able to determine bookings that will be cancelled will allow hotels to build infrastructure that allows them to process refunds or update their booking systems. At the .30 threshold, our model accurately identifies over 75% of the bookings that end up being canceled. It also has about a 25% false positive rate at that threshold, which means that about 25% of the time, it incorrectly identifies bookings which won't be canceled as canceled. If a hotel wants to identify which individual reservations might be canceled, a lower threshold would be more appropriate so that the true positive rate increases. Of course, that does come with the sacrifice of more false cancellation flags. Regardless, we assume hotels are primarily concerned with estimating the amount of reservations that might get canceled. Towards that end, a `0.30` threshold likely provides an accurate result a majority of the time while minimizing the false positive rate.



## Limitations.

Through our analysis, we've generated a logistic regression model to predict hotel cancellations. Again, it is important to note that our data was sourced from limited locations, particularly one city hotel and resort, both located in Portugal. Thus, our model should only be used to generalize to hotels with Portugal at most. The model will be best applicable to just the two hotels that our data came from. In fact, we progressed with our analysis with this at mind. Specifically, we took this in as a major consideration when deciding a threshold for our logistic model. We wanted to take into account the financial implications of hotel cancellations in order to weigh the costs and benefits of utilizing our model. 
Given that our model is based on data from only two hotels, we would have liked to source data from more locations. For example, if we had data from more hotels of various types within Portugal, we could likely extend our model to create cancellation predictions for hotels in Portugal as a whole. And beyond that, if we had data from hotels around the world, we could further extend our model beyond just Portugal too. 

In addition, some changes or improvements we would like to consider include utilizing more interaction effects. Interaction effects are difficult to judge and intuition in itself might be insufficient to decide on these effects. Thus, a future direction could include testing various, if not all, the possible interaction effects (assuming sufficient processing capacilities) to improve our model. We would of course then again perform a backwards selection process to ultimately decide on what terms may or may not be statistically significant. 

It's also interesting to note that backwards selection using BIC only removed one variable from our model: `infants`. It apears that having children or babies truly didn't have a statistically significant impact on cancellations, as the test has shown us. However, we also must consider that we did construct this variable ourselves from the data. It is a combination of the count of children and babies in the booking, and thus that union might have an altered significance compared to that of those terms pre-merge. Regardless, it is then interesting to note that we were apparently pretty successful at deciding predictor variables for our model as the rest of the terms were not removed.

A reason that BIC might not have taken out many variables is because we had so many observations in the data set. We know that if we have a very large number of observations and we run hypothesis testing with the null hypothesis that the slope of a particular variable is 0, then no matter how small the slope truly is and no matter what significant level we assign, when n is sufficiently large, we will always reject the null hypothesis.


## Conclusion.

Through our analysis, we believe we've created a decently accurate logistic regression model that can be utilized to predict hotel cancellations. Specifically, our model can be generalized to two specific unnamed hotels in Portugal, one of which is a resort and the other is a hotel. 

We initially isolated 12 predictor variables and 4 interaction terms  of interest that we believed would be important in possibly predicting cancellations for these hotels. With these variables, we constructed a logistic linear model and performed a backward selection using BIC as the selection criterion to determine which variables we would ultimately decide to keep in our finalized model. Several predictor variables and interaction terms were removed. But ultimately, nearly all the interaction terms and another term (`lead_time_squared`) were too small to be practically significant. We ultimately landed on a model with 9 predictor variables and no interaction terms.

We weren't too sure what to expect when determining the model's accuracy, but we were pleasantly surprised when constructing a ROC curve and calculating the AUC. We found that our model was able to differentiate cancellations about 81.08% of the time. Ultimately, we believe the model we've devised could definitely be of practical use to those hotels, helping them to predict and prepare for hotel cancellations that they could lose revenue from. But it is again critical to note, as we've done in the limitations section, that this model is very specific and should not be generalized further than those two hotels. In the future though, we hope to be able to devise a model that may extend beyond those two hotels, perhaps into all of Portgual. But we'll need a good dataset for that.

For additional details and computations, please see the following section.


## Additional Work

### Additional EDA

#### `adults`

```{r adults, fig.height=3}
# plot number of adults per booking
p1 <- ggplot(hotels_small, mapping = aes(x = adults)) +
  geom_histogram(binwidth = 1) +
  labs(x = "Number of Adults", y = "Count", title = "Adults per Booking")

p2 <- ggplot(hotels_small, mapping = aes(x = infants)) +
  geom_bar() +
  labs(x = "Infants", y = "Count", 
       title = "Infants per Booking")

# summarize number of adults per booking
  p1 / gridExtra::tableGrob(hotels_small %>%
                            summarize(min = min(adults), q1 = quantile(adults, 0.25), median = median(adults), 
                         q3 = quantile(adults, 0.75), max = max(adults), IQR = IQR(adults),
                            loweroutlier = (q1 - 1.5*IQR), upperoutlier = (q3 + 1.5*IQR))) 
```

From graph of `adults`, the number of adults per booking, we can see that the distribution is skewed right. The center (median) is at 2 adults. The spread is 0, which means that the vast majority of bookings only are for 2 adults. However, it appears that there are outliers towards the higher end of the spectrum (above 2 adults). The maximum for the distribution is 55 adults, which is very large and may represent a group booking. The minimum number of adults for a booking is 0.  This seems unusual, as it makes no sense to have a booking that has no adults (an empty room). We are only interested in being able to predict cancellations for bookings with a reasonable number of adults on the booking, so we will only consider observations with `0 < adults <= 10`.

#### `infants`

```{r infants, fig.height=3, fig.width=6}
# plot number of infants
p1 <- ggplot(hotels_small, mapping = aes(x = infants)) +
  geom_bar() +
  labs(x = "Infants", y = "Count", 
       title = "Infants per Booking")

# summarize number of infants
p1 +gridExtra::tableGrob(hotels_small %>%
  count(infants) %>%
  mutate(n = n, prop = n/sum(n)))
```

From graph of `infants`, an indicator of whether a booking includes infants (children or babies) or not, we can see that the vast majority of bookings (92.18%) have 0 infants (are adults only).

#### `length_stay`

```{r length_stay, fig.height=3}
# plot number of weekday nights
p1 <- ggplot(hotels_small, mapping = aes(x = length_stay)) +
  geom_histogram(binwidth = 1) +
  labs(x = "Length of Stay (Days)", y = "Count", 
       title = "Length of Stay")

# summarize number of weekday nights
p1 / gridExtra::tableGrob(hotels_small %>%
  summarize(min = min(length_stay), q1 = quantile(length_stay, 0.25), 
            median = median(length_stay), q3 = quantile(length_stay, 0.75), 
            max = max(length_stay), IQR = IQR(length_stay),
            loweroutlier = (q1 - 1.5*IQR), upperoutlier = (q3 + 1.5*IQR)))
```

From graph of `length_stay`, the number of nights stayed for a given booking, we can see that the distribution is skewed right. The center (median) is at 3 nights, meaning that most bookings include 3 nights as part of their stay. The spread is 2 days, which means that there is not a lot of variability in the number of nights stayed per reservation and that the length of a stay is generally on the short-term side. However, it appears that there are outliers towards the higher end of the spectrum (above 7 nights). The maximum for the distribution is 69 nights, a little over 2 months, which probably belongs to a long-term hotel stay. We will consider all lengths of stay and not filter out any outliers.

#### `is_repeated_guest`

```{r is_repeated_guest, fig.width=8, fig.height=3}
# plot repeated guest
p1 <- ggplot(hotels_small, mapping = aes(x = is_repeated_guest)) +
  geom_bar() +
  labs(x = "Is a Repeated Guest", y = "Count", title = "Repeated Guests")

# count repeated guest
p1 + gridExtra::tableGrob(hotels_small %>%
  count(is_repeated_guest) %>%
  mutate(n = n, prop = n/sum(n)))
```

From the bar chart of `is_repeated_guest`, which is an indicator of whether a client is a repeated guest at the hotel, we can see that the vast majority of bookings in the data set (96.81%) were made by first-time guests, while the remaining bookings (3.19%) were made by repeated guests.

#### `origin`

```{r origin, fig.width=6, fig.height=3}
# plot domestic vs international
p1 <- ggplot(hotels_small, mapping = aes(x = origin)) +
  geom_bar() +
  labs(x = "Origin of Guest", y = "Count", title = "Domestic vs. International Guests")

# count domestic vs international
p1 + gridExtra::tableGrob(hotels_small %>%
  count(origin) %>%
  mutate(n = n, prop = n/sum(n)))
```

From the bar chart of `origin`, which provides information on whether a client is a domestic traveler (within Portugal) or a international traveler, we can see that the majority of clients in the data set (59.30%) are international travelers, while the remaining clients (40.70%) are domestic travelers (from Portugal).

#### `season`

```{r seasons, fig.height=3, fig.width=6}
# plot season
p1 <- ggplot(hotels_small, mapping = aes(x = season)) +
  geom_bar() +
  labs(x = "Season of Check-in", y = "Count", title = "Season of Check-In")

# count season
p1 + gridExtra::tableGrob(hotels_small %>%
  count(season) %>%
  mutate(n = n, prop = n/sum(n)))
```

From the bar chart of `origin`, which provides information on what season the check-in for a booking occurred, we can see that the majority of bookings in the data set (31.39%) were made for the summer, followed by spring, then fall, and then finally winter (17.40%). This makes sense, as the warmer months tend to have more observations and people normally prefer to travel in nice weather.

#### `changed`

```{r changed, fig.width=6, fig.height=3}
# plot number of booking changes
p1 <- ggplot(hotels_small, mapping = aes(x = changed)) +
  geom_bar() +
  labs(x = "Booking Changed", y = "Count", title = "Changed")

# summarize number of booking changes
p1 + gridExtra::tableGrob(hotels_small %>%
  count(changed) %>%
  mutate(n = n, prop = n/sum(n)))
```

From graph of `changed`, an indicator of whether a booking has been modified or not, we can see that the vast majority of bookings (84.86%) have never been changed from their original booking.

####  `adults` and `infants` vs. `is_cancelled`

```{r adults-vs-is-cancelled, warning = FALSE, fig.height=3}
p1 <- ggplot(hotels_small, aes(adults, fill = is_canceled)) +
  geom_histogram(position = "fill", binwidth = 5) +
  labs(x = "Number of Adults per Booking", y = "Proportion",
       title = "Cancellation vs. Adults", fill = "Is Canceled")

p2 <- ggplot(hotels_small, aes(infants, fill = is_canceled)) + 
  geom_bar(position="fill") +
  labs(x = "Infants", y = "Proportion",
       title = "Cancellation vs. Infants", fill = "Is Canceled")

p1 + p2
```

The bar chart for `is_canceled` by `adults` shows that for bookings that have between 0 and 3 adults, the larger proportion of bookings are not cancelled. On the other hand, as the number of adults increase, especially for number of adults between 20 and 60, all of these bookings are canceled.

The bar chart for `is_ canceled` by `infants` shows that the number of infants does not look like it has a big effect on cancellations. We can see that proporiton of cancellations are about the same for bookings that have infants and bookings that do not have infants.

#### `length_stay` vs. `is_canceled`

```{r length_stay-canceled, warning = FALSE, fig.height=2.8}
ggplot(hotels_small, aes(length_stay)) +
  geom_histogram(binwidth = 1, fill= "darkorange") +
  facet_wrap(vars(is_canceled)) +
  xlim(-1,10) +
  labs(x = "Length of Stay (Days)", y = "Count",
       title = "Cancellation vs. Length of Stay")
```

The histogram of `length_stay` by `is_canceled` shows that there is no significant difference in the distributions of lead time for canceled reservations vs. non-canceled reservations. For both canceled reservations and non-canceled reservations, the length of stay with the highest frequency is between 2 and 3 nights. The average length of stay is usually between 1 and 4 nights.

#### `origin`, `repeated_guest`, and `hotel` vs. `is_canceled`

```{r prev-cancel-origin-vs-is-cancelled, message = FALSE, warning = FALSE}
# origin
p1 <- ggplot(hotels_small, mapping = aes(x = origin, fill = is_canceled)) +
  geom_bar(position = "fill") +
  labs(x = "Is Canceled", y = "Proportion", title = "Cancellation vs. Origin")

# repeated guest
p2 <- ggplot(hotels_small, mapping = aes(x = is_repeated_guest, fill = is_canceled)) +
  geom_bar(position = "fill") +
  labs(x = "Is Repeated Guest", y = "Proportion", title = "Cancellation vs. Is Repeated Guest")

# type of hotel
p3 <- ggplot(hotels_small, mapping = aes(x = hotel, fill = is_canceled)) +
  geom_bar(position = "fill") +
  labs(x = "Hotel Type", y = "Proportion", title = "Cancellation vs. Hotel Type")
  
p1 + (p2/p3)
```

The bar plot `is_canceled` by `origin` shows that for reservations where the guest is domestic, the proportion of cancelations is greater than the proportions for non cancelations. For reservations where the guest is international, the proportion of non cancellations if far bigger than the proportion of cancelations.

The bar plot `is_canceled` by `is_repeated_guest` shows that for both repeat and non-repeat guests, the proportion of non-cancelations is far higher than the proportion of cancelations, although repeat guests have a lower cancelation rate than non-repeat guests.

The bar plot `is_canceled` by `hotel`shows that for both city and resort hotels, the proportion of non-cancelations is far higher than the proportion of cancelations, although resort hotels have a lower cancelation rate than city resorts.

#### `season` vs `is_canceled`

```{r season-vs-is-cancelled, fig.height=2.5}
ggplot(hotels_small, aes(x=season, fill=is_canceled)) + 
  geom_bar(position="fill") +
  scale_fill_brewer(palette="Reds") +
  theme_classic() +
  labs(x = "Season", y = "Propotion", fill = "Is Cancelled", 
       title = "Cancellation vs. Season")
```
The bar graphs for `season` by `is_canceled` shows that the distribution of `seasons` is roughly the same across canceled and non canceled reservations. Every season, the proportion of canceled reservations vs. non-canceled reservations stays rougly the same across the seasons. Summer has a slightly higher rate of cancelations than other seasons and winter has a slightly lower rate of cancelation than other seasons.

### Interaction Analysis

Next, we'll plot the interaction variables to determine if there is any possible relationship or collinearity. 

```{r multicollinearity, warning = FALSE}
p1 <- ggplot(hotels_subset, aes(x = changed, y = lead_time)) +
  geom_boxplot() +
  coord_flip() +
  labs(title = "Changed vs. Lead Time", y = "Lead Time (Days)") +
  ylim(0, 365)

p2 <- ggplot(hotels_subset, aes(x = season, y = adr)) +
  geom_boxplot() +
  coord_flip() +
  labs(title = "Season vs Average Daily Rate", y = "Average Daily Rate") +
  ylim(0, 212)

p3 <- ggplot(hotels_subset, aes(x = hotel, y = adr)) +
  geom_boxplot() +
  coord_flip() +
  labs(title = "Hotel Type vs Average Daily Rate", y = "Average Daily Rate") +
  ylim(0, 1000)

p4 <- ggplot(hotels_subset, aes(x = season, y = lead_time)) +
  geom_boxplot() +
  coord_flip() +
  labs(title = "Season vs Lead Time", y = "Lead Time (days)") 

par(mfrow = c(2,2))
p1 + p2 + p3 + p4
```

There does not seem to exist a strong association between `lead_time` and `changed`, as the distribution looks exactly the same for changed and unchanged reservations.

There may exist an interaction between the numerical variables `season` and `adr` because it seems that on average, the average daily rate for hotel bookings in the summer is larger than the other average daily rates. Furthermore, it seems that average daily rate for winter bookings are lower than other average daily rates.

There does not seem to exist as strong as an association between `hotel_type` and `adr`. 

There also may exist an interaction between `season` and `lead_time`. According to the box plot (bottom right), people in the data set tended to make their summer bookings more ahead of time than winter bookings.

### Model Fitting Process

Below we fit the full model with all four of the interactions we were interested in exploring earlier.

```{r fit-model}
canceled_m <- glm(is_canceled ~ 
                    adrCent +  
                    adultsCent +
                    season + 
                    infants +
                    changed +
                    origin +
                    hotel + 
                    is_repeated_guest + 
                    lead_time_squared +
                    market_segment +  
                    prior_cancellation +
                    length_stayCent +
                    (season * adrCent) +
                    (season * lead_time_squared) +
                    (hotel * adrCent) +
                    (changed * lead_time_squared),
                  data = hotels_subset, 
                  family = binomial)

tidy(canceled_m, conf.int=TRUE, exponentiate=FALSE) %>%
  kable(format="markdown", digits=3)
```

Using the `step` function, we will perform a backward selection on multiple linear regression models with BIC as the selection criteria. We do this by setting k = log(n), in which k is the degrees of freedom. We chose BIC as the selection criterion because we have a lot of variables and want to strictly penalize for any variables that are not truly necessary. Since our model is intended to be used by hotel personnel, we want to keep it as simple and efficient as possible.

```{r select-model}
BIC_model <- step(canceled_m, 
                  direction = "backward",
                  k = log1p(10000)
                  )
tidy(BIC_model, conf.int=TRUE, exponentiate=FALSE) %>%
  kable(format="markdown", digits=3)

```

The backwards selection using BIC removed the following variables: `adultsCent`, `infants`, and all of the interaction variables. 

We can see that BIC did not remove the variable `lead_time_squared`, but the estimated coefficient is approximately 0. Therefore, although this variable is statistically significant due to the large sample size, it is not practically significant and thus we will remove it from the model. 

### Interpretation of Intercept

We expect the odds of a domestic City hotel booking made the day of (lead_time = 0) in the Spring with an average daily rate of 97.80 dollars made for 3.42 days and for 2 adults by someone who is not a repeated guest, has made no booking changes, and has made no previous cancellations to be `r exp(0.173)`.
 
### Interpretation of Coefficients

We will interpret the coefficient of one categorical variable (`origin`), one numerical variable (`adrCent`), and one interaction variable (`is_repeated_guest1:previous_canellations`). 

`origin`: The odds of a booking with an international origin being canceled is expected to be `r exp(-1.957)` times the odds of a booking with a domestic origin, holding all else constant. In other terms, domestic bookings have larger odds of being canceled, on average and holding all else constant. 

`adrCent`: Holding all else constant, for every dollar increase in the average daily rate, odds of a booking being canceled multiplies by a factor of `r exp(0.009)`. 

`adrCent:hotelResort Hotel`:  Holding all else constant, for every dollar increase in the average daily rate, we expect the odds of a booking being canceled to multiply by a factor `r exp(-0.003)` if a hotel is a Resort Hotel versus if it is a City Hotel. 


### AIC Model Check

We can also perform a backwards selection using AIC as our criterion instead to determine if there's any difference from our current model selection.

```{r select-model-aic}
select_model_aic <- step(canceled_m, 
                     direction = "backward",
                     criterion = "AIC"
                     )
tidy(select_model_aic, exponentiate = FALSE) %>%
  kable(format = "markdown", digits = 3)

# calculating predictions and residuals
canceled_m_aug_aic <- augment(select_model_aic, type.predict = "response", type.residuals = "response")
canceled_m_aug_aic <- canceled_m_aug_aic %>%
  mutate(obs_num = 1:n())

# ROC from select_model
roc_curve_aic <- ggplot(canceled_m_aug_aic, 
                    aes(d = as.numeric(is_canceled) - 1,
                        m = .fitted)) + 
  geom_roc(n.cuts = 10, labelround = 3) + 
  geom_abline(intercept = 0) + 
  labs(x = "False Positive Rate (1 - Specificity)",
       y = "True Positive Rate (Sensitivity)")

# calculate auc
auc_aic <- calc_auc(roc_curve_aic)$AUC
```

```{r aic-bic}
# model comparison with AIC
glance(select_model)$AIC
glance(select_model_aic)$AIC

# model comparison with BIC
glance(select_model)$BIC
glance(select_model_aic)$BIC
```

We can see that backwards selection using AIC as the criterion produces the same model as the model produced when BIC is used as the criterion.

### K-Fold Validation

The k-fold cross validation method involves splitting the dataset into k-subsets. In this instance, we will use 10 subsets, as our data set includes close to 100,000 observations. One subset is used as the testing set, while the model is trained on all other subsets. This process is completed until accuracy is determined for each of the 10 rounds of validation, and an overall accuracy estimate is provided. Therefore, k-fold validation is a robust method for estimating model accuracy. As the goal of our analysis is to make accurate predictions about whether a booking will or will not be cancelled, we certainly care about accuracy.

Below, we use 10-fold cross validation to estimate the generalized linear model on the `hotels_small` dataset. For this analysis, we will use functions from the `caret` package.

```{r k-fold-validation}
data_ctrl <- trainControl(method = "cv", number = 10)
model_caret <- train(is_canceled ~ 
                    adr +  
                    infants +
                    adults +
                    season + 
                    changed +
                    origin +
                    hotel + 
                    is_repeated_guest + 
                    lead_time_squared +
                    market_segment +  
                    prior_cancellation +
                    length_stay +
                    (lead_time_squared * changed) +
                    (season * adr) +
                    (hotel * adr) +
                    (season * lead_time_squared),   # model to fit
                     data = hotels_small,                        
                     trControl = data_ctrl,              # folds
                     method = "glm",                      # specifying regression model
                     na.action = na.pass)   
model_caret
model_caret$finalModel
summary(model_caret)
```

Accuracy is the proportion of accurate predictions, which in this case is 0.7611571. This means that the model produced by k-fold cross validation correctly predicts for about 76.127% of bookings, which is pretty good! We can see that cross validation removed `infants`, which is the same result from our BIC test above.







